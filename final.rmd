---
title: "\\vspace{-2cm} Stat 405 Final"
author: "Meera Borle, Isis Burgos, Naomi Consiglio, Carson Foster, Aidan Gerber"
date: "December 10th, 2022"
fontsize: 12pt
geometry: margin=1in
mainfont: Times New Roman
colorlinks: yes
output:
  pdf_document:
    default
  prettydoc::html_pretty:
    toc: yes
    toc_depth: 3
    theme: hpstr
    highlight: tango
    df_print: paged
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
header-includes: \usepackage{setspace}
---
\doublespacing
```{r setup, include=FALSE}
options(scipen = 999)
options(digits = 2)
# for PDF full
# knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, dev = 'png')
# SHOW_BACK_TO_TOP=FALSE
# for PDF no code
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dev = "png", results = "hide", out.width = "100%", fig.align = "center", dpi = 300)
SHOW_BACK_TO_TOP <- FALSE
# for html with svg
# knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dev = 'svglite', out.width="100%")
# SHOW_BACK_TO_TOP=TRUE
```

```{r imports}
library(tidyverse)
library(RSQLite)
library(grid)
```

```{r include-db, include = FALSE}
db <- dbConnect(SQLite(), "data/mortality.sqlite")
initRegExp(db)
query <- function(q) {
    req <- dbSendQuery(db, q)
    results <- dbFetch(req)
    dbClearResult(req)
    results
}
```
# Introduction
Our main dataset is a mortality dataset from the National Bureau of Economic Research. There are new versions of it each year and we are using the 2019 version. Each row is one death based on information filed in death certificates in the 50 states plus Washington DC. Columns are factors regarding the status of persons involved in deaths that can be gleaned from public death certificates. The dataset is focused on the different causes of death. Notable information the dataset contains is education, sex, age classification, day of month, place of death, weekday, manner of death, cause of death, and different risk factors that the deceased had.

## Secondary Dataset
For our secondary dataset, we are using the Behavioral Risk Factor Surveillance System Survey. This survey includes different free text survey questions from across the United States and territories with responses broken out by subgroup. There is also information on sample size, percent affirmative response, and confidence interval bounds. We will combine the secondary dataset by matching up subgroups between the death dataset and the risk factor dataset and trying to use aggregate statistics to analyze how risk factors can be matched with causes of death.

# Questions
We are interested in what different factors are correlated with higher death rates based on cause of death, age groups, and weekdays. Depending on the different causes, different policies can be recommended. Moreover, we can break down the different causes of death by demographics such as race, age, and sex to determine where resources should specifically be directed. 

# Exploration
## Deaths by Weekday
First, we plotted weekday of death versus death counts. There were the most deaths on Tuesday. However, days have an average of `r query("SELECT count(*) FROM mortality")$count / 365` deaths and 2019 had an extra Tuesday so adjusting for that, the most deaths were on Fridays.

```{r plot_weekday_deaths}
source("plots/weekday_deaths.r", local = TRUE, print.eval = TRUE)
```

## Deaths by Month
```{r plot_month_deaths}
source("plots/month_count.r", local = TRUE, print.eval = TRUE)
```

## Deaths by Age
Next, we plotted age versus death counts. Deaths were most prevalent among older age groups such as those between 70 and 84, although deaths start increasing more quickly at age 60. There is also a spike in those less than 1 day old. However, those greater than 1 day old do not frequently die.

```{r plot_age_deaths, fig.height = 11, fig.width = 8}
source("plots/age_deaths.r", local = TRUE, print.eval = TRUE)
```

## Deaths by Manner
Here, we plotted the manner of death versus age and counted how many people of a certain aged died based on a certain manner of death. A few key finding of this analysis shows that the majority of people die from natural causes, especially those aged 60+ and less than 1 day old, and accidental causes, spanning across all age groups. What this plot may help to inform us about is the behavior and activities that people in a general age group may commonly engage in that may have lead to their manner of passing. By being observant of the manners of death based on age group, preventative methods can be used to decrease the number of accidental related deaths if we are able to determine commonly engaged activities for age groups. Using this plot will help us answer the cause of death among the different age groups, and further promote research in what actual activities people are participating in that lead to their manner of death.

```{r plot_age_manner, fig.height = 11, fig.width = 8}
source("plots/age_manner.r", local = TRUE, print.eval = TRUE)
```

## Deaths by Age and Gender
In this plot, we plotted the number of deaths versus age ranges while demonstrating how many men compared to women passed away in each age category. In each of the bars, the red fill represents the amount of women who passed away in that particular age range while the blue accounts for the amount of men. The percentage seen in each bar represents the proportion of men in a given age range that passed away. This analysis shows that the majority of people under the age of 80 who pass away tend to be men, as nearly every bar from ages 0-80 shows the proportion of male deaths to be above 50%. This proportion of male deaths goes down after 80 years of age, and is likely because women who are of an older age tend to live to a complete life expectancy. What this plot may help to inform us about is the differences in male and females lives and life expectancies. Further research into differences in lifestyle choices for men versus women as a whole may help better explain why women tend to live longer than men. Furthermore, this plot accompanied with a plot on cause of death by gender, may assist in determining what kind of, potentially more risky, behaviors men may partake in during their lifetimes that lead to an earlier death than women.
```{r plot_age_gender, fig.height = 11, fig.width = 8}
source("plots/age_gender.r", local = TRUE, print.eval = TRUE)
```

## Cause of Death by Education
For most causes of death, level of education does not have an impact on what proportion of people have that cause of death. The largest difference belongs to "Certain conditions originating in the perinatal period" with high occurrences in those with 8th grade or less education and those with unknown education and nearly no occurrences in all others. Another large proportion difference is in "Congenital malformations" where 8th grade or less has a much higher mortality proportion than other education levels. For causes of death that are not highly tied to conditions at birth, "Syphilis" and "Assault (homicide)" have the highest differing proportions. "Syphilis" has a quite small sample size but unknown education has the highest mortality proportion. For "Assault (homicide)", 9 - 12th grade, no diploma has the highest mortality proportion.
```{r plot_education_cause, fig.height = 11, fig.width = 8}
source("plots/educ_cause.r", local = TRUE, print.eval = TRUE)
```

## Free Text Analysis: Selected Health Conditions by Age Group
Using regular expressions, we polled the BRFSS data set for questions related to heart conditions, cancer, and depression, while grouping by the age of respondents. Furthermore, we restricted entries to those where participants responded positively, indicating that they did have those conditions. Interestingly, all age groups except 65+ had a high incidence of depression, hovering around the 20% mark. This dips significantly to 15% for the 65+ age group, perhaps because mental health was more stigmatized during their lives and psychological diagnoses were less readily available. In addition, the orange and olive green lines (for heart attack and coronary heart disease, respectively) have a significant degree of overlap, which makes sense, given the conditions. The green line (corresponding to non-skin cancer), is slightly higher then the blue line (corresponding to skin cancer) for all age groups. Furthermore, both cancer have positive slopes, indicating that as your age increases, you become more likely to be diagnosed with cancer.
```{r plot_conditions_text, fig.height = 7, fig.width = 8}
source("plots/cancer.r", local = TRUE, print.eval = TRUE)
```

```{r disconnect-db, include = FALSE}
dbDisconnect(db)
```